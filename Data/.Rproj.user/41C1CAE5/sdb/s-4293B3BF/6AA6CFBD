{
    "contents" : "#Import Libraries\nlibrary(reshape2)\nlibrary(ggplot2)\nlibrary(plyr)\nlibrary(plotrix)\nlibrary(ggplot2)\nlibrary(reshape2)\nlibrary(plyr)\nlibrary(drc)#this one is for the dose response curve\nlibrary(tidyverse)\nlibrary(kimisc)\nlibrary(data.table)\nlibrary(combinat)\nlibrary(gtools)\nlibrary(wesanderson)\nlibrary(platetools)\nlibrary(ggplot2)\nlibrary(viridis)\n\n\n\n#Import Data####\nsubj <- dir(path = \"Raw Data/TMA_DR_jars\", pattern=\"\\\\.txt$\", full.names=TRUE) # creating a list of all file names\nnames(subj)  <- basename(subj)\ndf <- ldply(subj, read.delim, stringsAsFactors=FALSE) \n\n#subset the data\ndf.jars <- subset(df, select = c(\"Subject\", \"Trial\", \"TrainList\", \"Running.Block.\", \"IntensityRating\",\"Jar\",\"Concentration\", \"Session\")) \ndf.jars$IntensityRating.inv <- 580-as.integer(df.jars$IntensityRating)\n\n#Trial Data\ndf.trialJars <- subset(df.jars, Running.Block. == \"Test\", select = c(\"Subject\", \"Trial\",  \"Running.Block.\", \"IntensityRating.inv\",\"Jar\",\"Concentration\", \"Session\"))\n\n\n#Normalize####\nscale01 <- function(value, minValue, maxValue) {\n  (value - minValue)/(maxValue - minValue)\n}\n#returns dataframe with the minimum and maximum values for each subject\nsubjMinMax <- ddply(df.trialJars, .variables = c(\"Subject\"), .fun = summarize, minValue = min(IntensityRating.inv), maxValue = max(IntensityRating.inv))\n#merges the max and min values with the full dataframe\ndf.scaleJars <- merge(df.trialJars, subjMinMax)\n#calculates the normalized values using the scale function as written\ndf.scaleJars$normValue <- scale01(df.scaleJars$IntensityRating.inv, df.scaleJars$minValue, df.scaleJars$maxValue)\n\n#Plot all Subjects####\n#normalized\nggplot(data = df.scaleJars, aes(x = Concentration, y = normValue, color = factor(Subject))) +\n  geom_point() +\n  facet_wrap(~Subject)\n\n#plot all subjects raw data\nggplot(data = df.jars, aes(x = Concentration, y = IntensityRating.inv, color = factor(Running.Block.))) +\n  geom_point() +\n  facet_wrap(~Subject)\n\n\n\n#run HIll model#####\nTMAjars.model <- drm(formula = IntensityRating.inv~Concentration, data = subset(df.scaleJars, Subject !=6), fct = LL.4(fixed = c(1, NA, NA, NA), names = (c(\"Slope\", \"Top\", \"Bottom\", \"ED\"))))\nsummary(TMAjars.model)    \nTMAjars.graph = function(x){\n  summary(TMAjars.model)$coefficients[2,1] + (summary(TMAjars.model)$coefficients[1,1]-summary(TMAjars.model)$coefficients[2,1])/(1+10^((log10(summary(TMAjars.model)$coefficients[3,1]) - x)*1))\n}\n\ndf.scaleJars$logConcentration <- log10(df.scaleJars$Concentration)\ndf.scaleJars$logConcentration[which(df.scaleJars$logConcentration == -Inf)]=-3\n#drm is dose response model function , summary give sum. stats , \n#LL.4 sets the 4 parameters of sigmoid curve ( slope at 1, looking for other)\n\nggplot(data = subset(df.scaleJars, Subject !=6), aes(x = logConcentration, y = IntensityRating.inv, color = factor(Subject))) +\n  geom_point() +\n  stat_function(fun = TMAjars.graph)\n  ### Finally, this last bit doesn't run. Get this: Error in layer(data = data, mapping = mapping, stat = StatFunction, \n     #geom = geom,  : object 'model.TMAjars' not found\n\n  ####do this normalized#####\n  #run HIll model#####\nmodelAndGraph <- function(startingData, x, graphy, graphx,subCriteria){\n  df <- subset(startingData, Subject == subCriteria)\n  DR.model <- drm(formula = graphy~x, data = df, fct = LL.4(fixed = c(1, NA, NA, NA), names = (c(\"Slope\", \"Top\", \"Bottom\", \"ED\"))))\n      \n  graph.function = function(x){\n    summary(DR.model)$coefficients[2,1] + (summary(DR.model)$coefficients[1,1]-summary(DR.model)$coefficients[2,1])/(1+10^((log10(summary(DR.model)$coefficients[3,1]) - x)*1))\n  }\n#plot  \n  graph.DR = ggplot(data = df, aes(x = graphx, y = graphy)) +\n    geom_point() +\n    stat_function(fun = graph.function)\n  \n  return(graph.DR)\n}\n\nmodelAndGraph(df.scaleJars, Concentration, IntensityRating.inv, logConcentration, 44)\n\n#The concentrations for 40 and 47 are not correct using the Concentration from the eprime due to experimenter (Marissa's) mistake.\n#Real concentrations for 40 and 47 \njar_merge<- as.data.frame(c(1:14))\nnames(jar_merge) <- c(\"Jar\")\njar_merge$Concentration <- c(0.1, 1, 0, 0.6, 12, 3, 10, 9, 15, .3, 6, 18, 6, 0)\n\ndf.jars <- subset(df, select = c(\"Subject\", \"Trial\", \"TrainList\", \"Running.Block.\", \"IntensityRating\",\"Jar\"))\ndf.jars$IntensityRating.inv <- 580-as.integer(df.jars$IntensityRating)\ndf.diffJars <- subset(df.jars, Subject %in% c(40,47))\ndf.diffJars.merge <- merge(df.diffJars, jar_merge) #its okay that we are losing some because this is from the scale training\n#plot all subjects raw data\nggplot(data = df.diffJars.merge, aes(x = log10(Concentration), y = IntensityRating.inv, color = factor(Running.Block.))) +\n  geom_point() +\n  facet_wrap(~Subject)\n\n#This is crazy variable - not convinced this works - also we may need to refresh the odors already. \n\n#####################################################################################################################\n\n#Plot Just Dardalie - agitated versus not agitated\n\n#####################################################################################################################\n#plot just Dardalie\ndf.jars$Session2 <- factor(df.jars$Session, levels = c(\"1\", \"2\"), labels = c(\"Not Agitated\", \"Agitated\"))\nggplot(data = subset(df.jars, Subject == 1000 & Session2 %in% c(\"Not Agitated\", \"Agitated\")), aes(x = Concentration, y = IntensityRating.inv, color = Session2)) +\n  geom_point() +\n  ggtitle(\"Effect of agitating on TMA odor Intensity\")+\n  xlab(\"Intensity Rating\") +\n  ylab(\"Concentration of TMA\")\n\n#Get the DR curves\n#####Ran the Hill function from Experiment1_graphs_withCurves\ntemp_data_notAgitated <- subset(df.jars, Subject == 1000 & Session2 == \"Not Agitated\") #try with 0 point, and then bring it in later if this doesn't work\ntemp_data_agitated <- subset(df.jars, Subject == 1000 & Session2 == \"Agitated\") #try with 0 point, and then bring it in later if this doesn't work\nform <- formula(\"IntensityRating.inv ~ Concentration\")\nnew_data_for_plot_notAgitated <- HillEquationFit(temp_data_notAgitated, form, normalized = FALSE)\nnew_data_for_plot_agitated <- HillEquationFit(temp_data_agitated, form, normalized = FALSE)\n\n\n#test function plot\nprint(ggplot(temp_data_notAgitated, aes(x = Concentration, y = IntensityRating.inv)) +\n        geom_point() +\n        geom_line(data = new_data_for_plot_notAgitated, aes(x = Concentration, y = Prediction, color = \"blue\")) +\n        geom_ribbon(data = new_data_for_plot_notAgitated, aes(x = Concentration, y = Prediction, ymin = Lower, ymax = Upper, color = \"blue\"), alpha = 0.1) +\n        geom_line(data = new_data_for_plot_agitated, aes(x = Concentration, y = Prediction, color = \"red\")) +\n        geom_ribbon(data = new_data_for_plot_agitated, aes(x = Concentration, y = Prediction, ymin = Lower, ymax = Upper, color = \"red\"), alpha = 0.1) +\n        ggtitle(\"Not Agitated\")\n)\n#get mean and SEM\nsummary_test <- ddply(.data = subset(df.jars, Subject == 1000 & Session2 %in% c(\"Not Agitated\", \"Agitated\")), .variables = c(\"Concentration\", \"Session2\"), .fun = summarize, Intensity = mean(IntensityRating.inv), se = sd(IntensityRating.inv)/sqrt(length(IntensityRating.inv)))\nsummary_test[which(summary_test$Concentration == 0),]$Concentration <- .05\n#can come back and add linalool later (it was only used during the trainings)\n\n#plot\npng(\"Analysis/Figures/Experiment2_withCurves2.png\", width = 1200, height = 960)\nggplot(summary_test, aes(x = Concentration, y = Intensity)) +\n  geom_point(aes(color = Session2)) +\n  scale_colour_manual(values = c(\"#00BFC4\", \"#F8766D\", \"#F8766D\", \"#00BFC4\")) +\n  geom_line(data = new_data_for_plot_notAgitated, aes(x = Concentration, y = Prediction, color = \"#00BFC4\")) +\n  geom_ribbon(data = new_data_for_plot_notAgitated, aes(x = Concentration, y = Prediction, ymin = Lower, ymax = Upper, fill = \"#F8766D\"), alpha = 0.1) +\n  geom_line(data = new_data_for_plot_agitated, aes(x = Concentration, y = Prediction, color = \"#F8766D\")) +\n  geom_ribbon(data = new_data_for_plot_agitated, aes(x = Concentration, y = Prediction, ymin = Lower, ymax = Upper, fill = \"#00BFC4\"), alpha = 0.1) +\n  geom_errorbar(data = summary_test, aes(y = Intensity, colour = Session2, ymin = Intensity - se, ymax = Intensity + se), width = 0.1) + # error bars of samples\n  #scale_y_continuous(limits = c(0, 100), breaks = c(0, 1.4, 6.1, 17.2, 35.4, 53.3, 100), labels = c(\"\", \"Barely detectable\", \"Weak\", \"Moderate\", \"Strong\", \"Very strong\", \"Strongest imaginable \\nsensation of any kind\")) + \n  scale_y_continuous(limits = c(0, 35.4*5), breaks = c(0, 7, 30.5, 17.2*5, 35.4*5), labels = c(\"\", \"Barely detectable\", \"Weak\", \"Moderate\", \"Strong\")) +#yusuke's line *5 \n  ggtitle(\"Effect of Agitating Jars on TMA Odor Intensity\")  +\n  xlab(\"log[TMA] (mM)\") +\n  ylab(\"Intensity Rating\") +\n  scale_x_log10() +\n  theme_bw() +\n  theme(legend.title = element_blank(), \n        legend.position = \"none\", \n        text = element_text(size = 16))\n  \n",
    "created" : 1500585117926.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1456801878",
    "id" : "6AA6CFBD",
    "lastKnownWriteTime" : 1502285388,
    "path" : "~/Downloads/TMA_Jars.R",
    "project_path" : null,
    "properties" : {
    },
    "relative_order" : 2,
    "source_on_save" : false,
    "type" : "r_source"
}